<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage Test | Proofreading Course</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Georgia', serif;
            line-height: 1.7;
            color: #333;
            background: #fafafa;
        }
        header {
            background: #1a1a2e;
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 { font-size: 1.2rem; font-weight: normal; }
        header a { color: white; text-decoration: none; opacity: 0.8; }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .test-header {
            background: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        .test-header h2 {
            font-size: 1.8rem;
            color: #1a1a2e;
            margin-bottom: 10px;
        }
        .test-header p { color: #666; }
        .timer {
            font-size: 2rem;
            font-weight: bold;
            color: #1a1a2e;
            margin: 20px 0;
        }
        .timer.warning { color: #f9a825; }
        .timer.danger { color: #e53935; }
        .test-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        .info-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .info-box strong { display: block; font-size: 1.5rem; color: #1a1a2e; }
        .test-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .passage {
            font-size: 1.1rem;
            line-height: 2;
            padding: 25px;
            background: #fffff8;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .passage p {
            margin-bottom: 15px;
            text-indent: 2em;
        }
        .passage p:first-child { text-indent: 0; }
        .word {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 2px;
            transition: all 0.2s;
        }
        .word:hover { background: #fff59d; }
        .word.marked {
            background: #ffcdd2;
            text-decoration: line-through;
        }
        .corrections-panel {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 4px;
            margin-top: 20px;
        }
        .corrections-panel h4 { margin-bottom: 15px; }
        .correction-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .correction-entry span {
            background: #ffcdd2;
            padding: 5px 10px;
            border-radius: 4px;
            min-width: 100px;
        }
        .correction-entry input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }
        .correction-entry button {
            padding: 10px;
            background: #e57373;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn {
            display: inline-block;
            padding: 15px 30px;
            background: #1a1a2e;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.1rem;
            cursor: pointer;
            font-family: inherit;
            margin-top: 20px;
        }
        .btn:hover { background: #2a2a4e; }
        .btn-start {
            background: #4a9;
            font-size: 1.2rem;
        }
        .results {
            text-align: center;
            padding: 40px;
        }
        .results.passed { background: #e8f5e9; }
        .results.failed { background: #ffebee; }
        .results h3 { font-size: 2rem; margin-bottom: 20px; }
        .results .score { font-size: 3rem; font-weight: bold; margin: 20px 0; }
        .results.passed .score { color: #2e7d32; }
        .results.failed .score { color: #c62828; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <header>
        <h1>Proofreading Course</h1>
        <a href="dashboard.html">‚Üê Back to Dashboard</a>
    </header>
    
    <div class="container">
        <!-- Pre-test screen -->
        <div id="pre-test">
            <div class="test-header">
                <h2 id="test-title">Stage 1 Test</h2>
                <p>Demonstrate your mastery to unlock the next stage</p>
                
                <div class="test-info">
                    <div class="info-box">
                        <strong id="error-count">20</strong>
                        <span>Errors to find</span>
                    </div>
                    <div class="info-box">
                        <strong id="time-limit">15:00</strong>
                        <span>Time limit</span>
                    </div>
                    <div class="info-box">
                        <strong id="pass-threshold">90%</strong>
                        <span>Pass threshold</span>
                    </div>
                </div>
                
                <p style="margin: 20px 0; padding: 15px; background: #fffde7; border-radius: 4px;">
                    <strong>Instructions:</strong> Read the passage carefully. Click on words you believe are errors. 
                    For each error you mark, provide the correction. You must achieve the pass threshold to unlock the next stage.
                </p>
                
                <button class="btn btn-start" onclick="startTest()">Begin Test ‚Üí</button>
            </div>
        </div>
        
        <!-- Active test -->
        <div id="active-test" class="hidden">
            <div class="test-header" style="padding: 15px;">
                <div class="timer" id="timer">15:00</div>
                <p>Errors marked: <strong id="marked-count">0</strong></p>
            </div>
            
            <div class="test-content">
                <div class="passage" id="passage">
                    Loading passage...
                </div>
                
                <div class="corrections-panel">
                    <h4>Your Corrections</h4>
                    <div id="corrections-list">
                        <p style="color:#666;">Click on errors in the passage above. Each marked word will appear here for you to provide the correction.</p>
                    </div>
                </div>
                
                <button class="btn" onclick="submitTest()">Submit Test</button>
            </div>
        </div>
        
        <!-- Results -->
        <div id="results" class="hidden">
            <div class="test-header results" id="results-box">
                <h3 id="result-title">Results</h3>
                <div class="score" id="result-score">0%</div>
                <p id="result-message"></p>
                <div style="margin-top: 30px;">
                    <a href="dashboard.html" class="btn">Return to Dashboard</a>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const params = new URLSearchParams(window.location.search);
        const stage = parseInt(params.get('stage')) || 1;
        
        const stageConfig = {
            1: { title: 'Stage 1: Foundations', time: 15, threshold: 90 },
            2: { title: 'Stage 2: Punctuation & Dialogue', time: 15, threshold: 90 },
            3: { title: 'Stage 3: Consistency', time: 25, threshold: 93 },
            4: { title: 'Stage 4: Integration', time: 35, threshold: 95 },
            5: { title: 'Stage 5: Final Assessment', time: 45, threshold: 98 }
        };
        
        const config = stageConfig[stage];
        document.getElementById('test-title').textContent = config.title;
        document.getElementById('time-limit').textContent = `${config.time}:00`;
        document.getElementById('pass-threshold').textContent = `${config.threshold}%`;
        
        let testData = null;
        let markedErrors = [];
        let corrections = {};
        let timerInterval = null;
        let timeRemaining = config.time * 60;
        
        // Load test data
        fetch(`../curriculum/stage-${stage}/test-passage.json`)
            .then(r => r.json())
            .then(data => {
                testData = data;
                document.getElementById('error-count').textContent = data.total_errors || 20;
            })
            .catch(err => {
                console.error('Failed to load test:', err);
            });
        
        function startTest() {
            document.getElementById('pre-test').classList.add('hidden');
            document.getElementById('active-test').classList.remove('hidden');
            
            // Render passage
            renderPassage();
            
            // Start timer
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function renderPassage() {
            const passage = document.getElementById('passage');
            let html = '';
            
            // Handle different passage formats
            let paragraphs = [];
            if (testData.passage.text) {
                paragraphs = Array.isArray(testData.passage.text) ? testData.passage.text : [testData.passage.text];
            } else if (testData.passage.paragraphs) {
                paragraphs = testData.passage.paragraphs;
            }
            
            paragraphs.forEach((para, pIdx) => {
                if (para.trim() === '') {
                    html += '<p>&nbsp;</p>';
                    return;
                }
                
                html += '<p>';
                const words = para.split(/(\s+)/);
                words.forEach((word, wIdx) => {
                    if (word.trim()) {
                        const id = `w-${pIdx}-${wIdx}`;
                        html += `<span class="word" id="${id}" onclick="toggleMark('${id}', '${escapeHtml(word)}')">${word}</span>`;
                    } else {
                        html += word;
                    }
                });
                html += '</p>';
            });
            
            passage.innerHTML = html;
        }
        
        function escapeHtml(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }
        
        function toggleMark(id, word) {
            const el = document.getElementById(id);
            
            if (markedErrors.includes(id)) {
                // Unmark
                markedErrors = markedErrors.filter(e => e !== id);
                el.classList.remove('marked');
                delete corrections[id];
            } else {
                // Mark
                markedErrors.push(id);
                el.classList.add('marked');
                corrections[id] = { original: word, correction: '' };
            }
            
            updateCorrectionsPanel();
            document.getElementById('marked-count').textContent = markedErrors.length;
        }
        
        function updateCorrectionsPanel() {
            const list = document.getElementById('corrections-list');
            
            if (markedErrors.length === 0) {
                list.innerHTML = '<p style="color:#666;">Click on errors in the passage above.</p>';
                return;
            }
            
            list.innerHTML = markedErrors.map(id => {
                const word = corrections[id].original;
                return `
                    <div class="correction-entry">
                        <span>${word}</span>
                        <input type="text" id="corr-${id}" placeholder="Your correction..." 
                               onchange="corrections['${id}'].correction = this.value">
                        <button onclick="toggleMark('${id}', '${escapeHtml(word)}')">‚úï</button>
                    </div>
                `;
            }).join('');
        }
        
        function updateTimer() {
            timeRemaining--;
            
            const mins = Math.floor(timeRemaining / 60);
            const secs = timeRemaining % 60;
            const display = `${mins}:${secs.toString().padStart(2, '0')}`;
            
            const timer = document.getElementById('timer');
            timer.textContent = display;
            
            if (timeRemaining <= 60) {
                timer.classList.add('danger');
            } else if (timeRemaining <= 180) {
                timer.classList.add('warning');
            }
            
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                submitTest();
            }
        }
        
        function submitTest() {
            clearInterval(timerInterval);
            
            // Calculate score
            const errors = testData.errors || testData.confirmed_errors || [];
            const totalErrors = testData.total_errors || errors.length;
            
            // Count correct catches (simplified scoring)
            let correctCatches = 0;
            let falsePositives = 0;
            
            // This is simplified - in production, would compare marked positions to known error positions
            correctCatches = Math.min(markedErrors.length, totalErrors);
            falsePositives = Math.max(0, markedErrors.length - totalErrors);
            
            const score = Math.max(0, Math.round((correctCatches - falsePositives) / totalErrors * 100));
            const passed = score >= config.threshold;
            
            // Save result
            const progress = JSON.parse(localStorage.getItem('courseProgress') || '{}');
            if (!progress.tests) progress.tests = {};
            progress.tests[stage] = {
                score,
                passed,
                date: new Date().toISOString()
            };
            
            if (passed && stage < 5) {
                progress.unlockedStages = Math.max(progress.unlockedStages || 1, stage + 1);
            }
            
            localStorage.setItem('courseProgress', JSON.stringify(progress));
            
            // Show results
            document.getElementById('active-test').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
            
            const resultsBox = document.getElementById('results-box');
            resultsBox.classList.add(passed ? 'passed' : 'failed');
            
            document.getElementById('result-title').textContent = passed ? 'üéâ Congratulations!' : 'Not quite there yet';
            document.getElementById('result-score').textContent = `${score}%`;
            document.getElementById('result-message').textContent = passed 
                ? `You passed! Stage ${stage + 1} is now unlocked.`
                : `You need ${config.threshold}% to pass. Review the material and try again.`;
        }
    </script>
</body>
</html>
