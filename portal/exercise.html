<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercises | Proofreading Course</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Georgia', serif;
            line-height: 1.7;
            color: #333;
            background: #fafafa;
        }
        header {
            background: #1a1a2e;
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 { font-size: 1.2rem; font-weight: normal; }
        header a { color: white; text-decoration: none; opacity: 0.8; }
        .container {
            max-width: 850px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .exercise-header {
            margin-bottom: 30px;
        }
        .exercise-header .stage { color: #666; font-size: 0.9rem; }
        .exercise-header h2 { font-size: 1.6rem; margin: 10px 0; color: #1a1a2e; }
        .exercise-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .exercise-nav button {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
        }
        .exercise-nav button.active {
            background: #1a1a2e;
            color: white;
            border-color: #1a1a2e;
        }
        .exercise-nav button.completed {
            border-color: #4a9;
            background: #e8f5e9;
        }
        #exercise-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .instructions {
            background: #f5f5f5;
            padding: 15px 20px;
            border-radius: 4px;
            margin-bottom: 25px;
            font-size: 0.95rem;
        }
        /* Single error exercise */
        .exercise-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        .exercise-item:last-child { border-bottom: none; }
        .exercise-item .text {
            font-size: 1.1rem;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        .exercise-item input[type="text"] {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }
        .exercise-item input:focus {
            outline: none;
            border-color: #1a1a2e;
        }
        .exercise-item .hint {
            font-size: 0.85rem;
            color: #666;
            margin-top: 8px;
        }
        /* MCQ */
        .mcq-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .mcq-options label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: #f8f8f8;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .mcq-options label:hover { background: #eee; }
        .mcq-options input { width: auto; }
        /* Passage proofing */
        .passage {
            font-size: 1.1rem;
            line-height: 2;
            padding: 20px;
            background: #fffff8;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .passage .word {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 2px;
            transition: background 0.2s;
        }
        .passage .word:hover { background: #fff59d; }
        .passage .word.marked {
            background: #ffcdd2;
            text-decoration: underline;
        }
        /* Buttons */
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #1a1a2e;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            font-family: inherit;
            margin-top: 20px;
        }
        .btn:hover { background: #2a2a4e; }
        /* Feedback */
        .feedback-box {
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .feedback-box.passed {
            background: #e8f5e9;
            border: 2px solid #4a9;
        }
        .feedback-box.failed {
            background: #ffebee;
            border: 2px solid #e57373;
        }
        .feedback-box h4 { margin-bottom: 10px; }
        .result-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .result-item.correct { background: #e8f5e9; }
        .result-item.incorrect { background: #ffebee; }
        .result-item .expected {
            color: #2e7d32;
            font-weight: bold;
        }
        .loading { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <header>
        <h1>Proofreading Course</h1>
        <a href="dashboard.html">← Back to Dashboard</a>
    </header>
    
    <div class="container">
        <div class="exercise-header">
            <span class="stage" id="stage-label">Stage 1</span>
            <h2 id="exercise-title">Exercises</h2>
        </div>
        
        <div class="exercise-nav" id="exercise-nav">
            <!-- Populated by JS -->
        </div>
        
        <div id="exercise-container">
            <div class="loading">Loading exercises...</div>
        </div>
    </div>
    
    <script>
        // Get params
        const params = new URLSearchParams(window.location.search);
        const stage = parseInt(params.get('stage')) || 1;
        const exerciseId = params.get('ex') || null;
        
        // Stage names
        const stageNames = {
            1: 'Foundations',
            2: 'Punctuation & Dialogue',
            3: 'Consistency',
            4: 'Integration',
            5: 'Speed & Assessment'
        };
        
        document.getElementById('stage-label').textContent = `Stage ${stage}: ${stageNames[stage]}`;
        
        let exercisesData = null;
        let currentExerciseIndex = 0;
        
        // Load exercises
        fetch(`../curriculum/stage-${stage}/exercises.json`)
            .then(r => r.json())
            .then(data => {
                exercisesData = data;
                buildNav(data.exercises);
                renderExercise(0);
            })
            .catch(err => {
                document.getElementById('exercise-container').innerHTML = 
                    '<p>Unable to load exercises. Please try again later.</p>';
            });
        
        function buildNav(exercises) {
            const nav = document.getElementById('exercise-nav');
            nav.innerHTML = exercises.map((ex, i) => 
                `<button onclick="renderExercise(${i})" id="nav-${i}">${ex.id}: ${ex.title}</button>`
            ).join('');
        }
        
        function renderExercise(index) {
            currentExerciseIndex = index;
            const exercise = exercisesData.exercises[index];
            
            // Update nav
            document.querySelectorAll('.exercise-nav button').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            
            document.getElementById('exercise-title').textContent = exercise.title;
            
            const container = document.getElementById('exercise-container');
            
            // Render based on type
            switch(exercise.type) {
                case 'single-error':
                    renderSingleError(container, exercise);
                    break;
                case 'identify-correct':
                case 'homophone-correction':
                    renderIdentifyCorrect(container, exercise);
                    break;
                case 'passage-proof':
                    renderPassageProof(container, exercise);
                    break;
                case 'multiple-choice':
                    renderMCQ(container, exercise);
                    break;
                default:
                    container.innerHTML = `<p>Exercise type "${exercise.type}" not yet supported.</p>`;
            }
        }
        
        function renderSingleError(container, exercise) {
            let html = `
                <p class="instructions">${exercise.instructions}</p>
                <form id="exercise-form" onsubmit="return submitSingleError(event)">
            `;
            
            exercise.items.forEach((item, i) => {
                html += `
                    <div class="exercise-item">
                        <p class="text">${i + 1}. ${item.text}</p>
                        <input type="text" name="answer-${i}" placeholder="Type the error and your correction..." 
                               data-error="${item.error}" data-correction="${item.correction}">
                        <p class="hint">Format: error → correction</p>
                    </div>
                `;
            });
            
            html += `<button type="submit" class="btn">Check Answers</button></form>
                     <div id="feedback"></div>`;
            container.innerHTML = html;
        }
        
        function submitSingleError(e) {
            e.preventDefault();
            const form = e.target;
            const exercise = exercisesData.exercises[currentExerciseIndex];
            let correct = 0;
            let html = '';
            
            exercise.items.forEach((item, i) => {
                const input = form[`answer-${i}`];
                const answer = input.value.toLowerCase().trim();
                const isCorrect = answer.includes(item.error.toLowerCase()) && 
                                  answer.includes(item.correction.toLowerCase());
                
                if (isCorrect) correct++;
                
                html += `
                    <div class="result-item ${isCorrect ? 'correct' : 'incorrect'}">
                        <p>${i + 1}. ${isCorrect ? '✓' : '✗'} "${item.text}"</p>
                        <p class="expected">Error: "${item.error}" → Correction: "${item.correction}"</p>
                    </div>
                `;
            });
            
            const score = Math.round(correct / exercise.items.length * 100);
            const passed = score >= 80;
            
            document.getElementById('feedback').innerHTML = `
                <div class="feedback-box ${passed ? 'passed' : 'failed'}">
                    <h4>${passed ? '✓ Passed!' : '✗ Keep practicing'}</h4>
                    <p>Score: <strong>${score}%</strong> (${correct}/${exercise.items.length})</p>
                </div>
                ${html}
            `;
            
            saveProgress(exercise.id, score);
            return false;
        }
        
        function renderIdentifyCorrect(container, exercise) {
            let html = `
                <p class="instructions">${exercise.instructions}</p>
                <form id="exercise-form" onsubmit="return submitIdentifyCorrect(event)">
            `;
            
            exercise.items.forEach((item, i) => {
                html += `
                    <div class="exercise-item">
                        <p class="text">${i + 1}. ${item.text}</p>
                        <input type="text" name="answer-${i}" placeholder="Your correction..." 
                               data-correction="${item.correction}">
                    </div>
                `;
            });
            
            html += `<button type="submit" class="btn">Check Answers</button></form>
                     <div id="feedback"></div>`;
            container.innerHTML = html;
        }
        
        function submitIdentifyCorrect(e) {
            e.preventDefault();
            const form = e.target;
            const exercise = exercisesData.exercises[currentExerciseIndex];
            let correct = 0;
            let html = '';
            
            exercise.items.forEach((item, i) => {
                const input = form[`answer-${i}`];
                const answer = input.value.toLowerCase().trim();
                const expected = item.correction.toLowerCase();
                const isCorrect = answer === expected || answer.includes(expected);
                
                if (isCorrect) correct++;
                
                html += `
                    <div class="result-item ${isCorrect ? 'correct' : 'incorrect'}">
                        <p>${i + 1}. ${isCorrect ? '✓' : '✗'}</p>
                        <p class="expected">Correct answer: "${item.correction}"</p>
                        ${item.explanation ? `<p><em>${item.explanation}</em></p>` : ''}
                    </div>
                `;
            });
            
            const score = Math.round(correct / exercise.items.length * 100);
            const passed = score >= 80;
            
            document.getElementById('feedback').innerHTML = `
                <div class="feedback-box ${passed ? 'passed' : 'failed'}">
                    <h4>${passed ? '✓ Passed!' : '✗ Keep practicing'}</h4>
                    <p>Score: <strong>${score}%</strong> (${correct}/${exercise.items.length})</p>
                </div>
                ${html}
            `;
            
            saveProgress(exercise.id, score);
            return false;
        }
        
        function renderMCQ(container, exercise) {
            let html = `
                <p class="instructions">${exercise.instructions}</p>
                <form id="exercise-form" onsubmit="return submitMCQ(event)">
            `;
            
            exercise.items.forEach((item, i) => {
                html += `
                    <div class="exercise-item">
                        <p class="text">${i + 1}. ${item.text.replace('_', '____')}</p>
                        <div class="mcq-options">
                `;
                item.options.forEach((opt, j) => {
                    html += `
                        <label>
                            <input type="radio" name="q${i}" value="${opt}" data-correct="${item.answer}">
                            ${opt}
                        </label>
                    `;
                });
                html += `</div></div>`;
            });
            
            html += `<button type="submit" class="btn">Check Answers</button></form>
                     <div id="feedback"></div>`;
            container.innerHTML = html;
        }
        
        function submitMCQ(e) {
            e.preventDefault();
            const exercise = exercisesData.exercises[currentExerciseIndex];
            let correct = 0;
            let html = '';
            
            exercise.items.forEach((item, i) => {
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                const isCorrect = selected && selected.value === item.answer;
                
                if (isCorrect) correct++;
                
                html += `
                    <div class="result-item ${isCorrect ? 'correct' : 'incorrect'}">
                        <p>${i + 1}. ${isCorrect ? '✓' : '✗'}</p>
                        <p class="expected">Correct answer: ${item.answer}</p>
                        <p><em>${item.explanation}</em></p>
                    </div>
                `;
            });
            
            const score = Math.round(correct / exercise.items.length * 100);
            const passed = score >= 80;
            
            document.getElementById('feedback').innerHTML = `
                <div class="feedback-box ${passed ? 'passed' : 'failed'}">
                    <h4>${passed ? '✓ Passed!' : '✗ Keep practicing'}</h4>
                    <p>Score: <strong>${score}%</strong> (${correct}/${exercise.items.length})</p>
                </div>
                ${html}
            `;
            
            saveProgress(exercise.id, score);
            return false;
        }
        
        function renderPassageProof(container, exercise) {
            let html = `
                <p class="instructions">${exercise.instructions}</p>
            `;
            
            exercise.items.forEach((item, i) => {
                html += `
                    <div class="exercise-item">
                        <h4>Paragraph ${i + 1}</h4>
                        <div class="passage">${item.text}</div>
                        <p style="margin-top:10px; color:#666;">Errors to find: ${item.total_errors || item.errors.length}</p>
                        <textarea name="errors-${i}" rows="4" style="width:100%; margin-top:10px; padding:10px;" 
                                  placeholder="List the errors you found..."></textarea>
                    </div>
                `;
            });
            
            html += `<button class="btn" onclick="showPassageAnswers()">Show Answers</button>
                     <div id="feedback"></div>`;
            container.innerHTML = html;
        }
        
        function showPassageAnswers() {
            const exercise = exercisesData.exercises[currentExerciseIndex];
            let html = '<div class="feedback-box passed"><h4>Answer Key</h4>';
            
            exercise.items.forEach((item, i) => {
                html += `<h4 style="margin-top:20px;">Paragraph ${i + 1}:</h4><ul>`;
                item.errors.forEach(err => {
                    html += `<li><strong>${err.error}</strong> → ${err.correction}</li>`;
                });
                html += '</ul>';
            });
            
            html += '</div>';
            document.getElementById('feedback').innerHTML = html;
        }
        
        function saveProgress(exerciseId, score) {
            const progress = JSON.parse(localStorage.getItem('courseProgress') || '{}');
            if (!progress.exercises) progress.exercises = {};
            progress.exercises[`${stage}-${exerciseId}`] = { score, date: new Date().toISOString() };
            localStorage.setItem('courseProgress', JSON.stringify(progress));
        }
    </script>
</body>
</html>
